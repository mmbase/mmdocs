<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Storage Conversions</title><link href="../../style/documentation.css" rel="stylesheet" type="text/css" /><meta content="DocBook XSL Stylesheets V1.72.0" name="generator" /><meta name="description" content="Storage conversion" /><link xmlns="" type="image/x-icon" href="../../style/favicon.ico" rel="icon" /><link xmlns="" type="image/x-icon" href="../../style/favicon.ico" rel="shortcut icon" /><meta xmlns="" content="text/html; charset=utf-8" http-equiv="content-type" /></head><body><div xmlns="" class="navigation"><img alt="mmbase logo" src="../../style/logo.png" /><h2>Storage Conversions</h2><p><a href="conversions.html#introduction">Introduction</a></p><p><a href="conversions.html#blobstofile">Converting blobs to files</a></p><p><a href="conversions.html#filestoblobs">Convert files to blobs</a></p><p><a href="conversions.html#datetime">Introducing 'DATETIME'</a></p><hr /><p><a href="http://www.mmbase.org">MMBase</a></p><p><a href="../../index.html">home</a></p></div><div class="article" lang="en"><div class="titlepage"><div><div><h1 class="title"><a id="N10001" />Storage Conversions</h1></div><div><div class="authorgroup"><strong class="authorgroup">Author: </strong><span class="author"><span class="firstname">Michiel</span> <span class="surname">Meeuwissen</span></span><br /><strong class="authorgroup">Date: </strong>2007-04-10</div></div><div><div class="legalnotice"><a id="N1001B" /><p>This software is OSI Certified Open Source Software. OSI Certified
      is a certification mark of the Open Source Initiative.</p><p>The license (Mozilla version 1.0) can be read at the MMBase site.
      See <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.mmbase.org/license" target="_top">http://www.mmbase.org/license</a></p></div></div><div><div class="abstract"><p class="title"><b>Abstract</b></p><p>Storage conversion</p></div></div></div><hr /></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="conversions.html#introduction">1. Introduction</a></span></dt><dt><span class="section"><a href="conversions.html#blobstofile">2. Converting blobs to files</a></span></dt><dt><span class="section"><a href="conversions.html#filestoblobs">3. Convert files to blobs</a></span></dt><dt><span class="section"><a href="conversions.html#datetime">4. Introducing 'DATETIME'</a></span></dt><dd><dl><dt><span class="section"><a href="conversions.html#datetime_psql">4.1. PostgreSQL</a></span></dt><dt><span class="section"><a href="conversions.html#datetime_mysql">4.2. MySQL</a></span></dt><dt><span class="section"><a href="conversions.html#datetime_hsql">4.3. HSQL</a></span></dt></dl></dd></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="introduction" />1. Introduction</h2></div></div></div><p>HOWTO on database-conversions</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="blobstofile" />2. Converting blobs to files</h2></div></div></div><p>In the MMBase admin pages is a tool to start the conversion. You
    will need to configure your database first. Change the option
    'database-supports-blob' to true:</p><pre class="programlisting">  &lt;!-- Use Blobs  --&gt;
  &lt;option name="database-supports-blob" value="true" /&gt;
</pre><p>Followed by these two lines of which the last line states the
    absolute path to which the blobs will be written.</p><pre class="programlisting">  &lt;option name="database-stores-binary-as-file" value="true" /&gt;
  &lt;attribute name="database-binary-file-path"&gt;/home/http/default/blob&lt;/attribute&gt;
</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="filestoblobs" />3. Convert files to blobs</h2></div></div></div><p>Can this be done?</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="datetime" />4. Introducing 'DATETIME'</h2></div></div></div><p>In MMBase 1.7 datetime were stored as 'LONG' or 'INTEGER' fields
    with 'guitype' 'eventtimes'. In 1.8 also 'DATETIME' is supported for
    database type. So if you have an existing installation, you may want to
    convert these fields.</p><p>It is simple to change the builder XML's, but the database will need
    a manual conversion.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="datetime_psql" />4.1. PostgreSQL</h3></div></div></div><p>To transform a column named 'begin' in the builder 'content' to
      DATETIME you can do the following. This is tested on Postgresql 7.2. It
      should also work on higher version, though it could be simplified there.
      For example you may want to drop the old column then (not supported in
      psql 7.2). <pre class="programlisting">
          alter table mm_content rename begin to begin_;
          alter table mm_content add column begin timestamp;
          update mm_content set begin = 'epoch';
          update mm_content set begin  = begin + CAST(begin_||'s' AS interval);
          # alter table drop column begin_; (not supported in 7.2)
        </pre></p><p>Because the column cannot be dropped MMBase will issue a warning
      on it's startup: <pre class="programlisting">
          13:36:55,810 8095kB WAR storage.implementation.database.DatabaseStorageManager - VERIFY: Column 'begin_' for builder 'categories' in Storage but not defined!
        </pre> This can safely be ignored, until the column can be
      dropped in some way. IIRC even newer version of postgresql cannot really
      drop the column, only hide it. In that case you can probably actually
      remove it by reimporting a database dump.</p><p>This works too (converting a column 'broadcasttime'):
      <pre class="programlisting">
          create table mm_programs2 (broadcasttime timestamp) inherits  mm_texts;
          insert into mm_programs2 (number,otype,owner,begin,m_end,visible,title,body,broadcasttime,lastmodifiedby,lastmodified) select number,otype,owner,begin,m_end,visible,title,body,  '1970-01-01'::date + CAST(broadcasttime ||'s' AS interval),lastmodifiedby,lastmodified from mm_programs;
          alter table mm_programs rename to mm_programs_orig; alter table mm_programs2 rename to mm_programs;          
        </pre> And then check if everthing is ok, and you can drop
      mm_programs_orig;</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="datetime_mysql" />4.2. MySQL</h3></div></div></div><p>This will convert your former MMBase date in MySQL in a proper
      DATETIME field. This was used and tested on MySQL 4.</p><pre class="programlisting">
  mysql&gt; ALTER TABLE intr_employees ADD birthdate DATETIME;  
  mysql&gt; UPDATE intr_employees SET birthdate = from_unixtime(dateofbirth);
  mysql&gt; ALTER TABLE intr_employees DROP COLUMN dateofbirth;  
  mysql&gt; ALTER TABLE intr_employees CHANGE birthdate dateofbirth DATETIME; 
        </pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="datetime_hsql" />4.3. HSQL</h3></div></div></div><p>Probably simply start from scratch...</p></div></div></div><hr xmlns="" /><p xmlns="">
      This is part of the <a href="http://www.mmbase.org">MMBase</a> documentation.
    </p><p xmlns="">
      For questions and remarks about this documentation mail to: 
      <a href="/cdn-cgi/l/email-protection#d7b3b8b4a2bab2b9a3b6a3beb8b997babab5b6a4b2f9b8a5b0"><span class="__cf_email__" data-cfemail="34505b574159515a4055405d5b5a745959565547511a5b4653">[email&#160;protected]</span></a></p><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script></body></html>